name: Testing-CI/CD

on:
 push:
   branches:
     - test-branch

env:
 DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
 DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
 DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
 
jobs:
 Build-Deploy:
   runs-on: ubuntu-latest

   steps:
     - name: Checkout
       uses: actions/checkout@v2


     - name: Set up Docker
       uses: docker/setup-buildx-action@v1

     - name: Login to Docker Hub
       uses: docker/login-action@v3
       with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

     - name: Determine Next Version
       id: version
       run: |
          # Get latest Git tag
          latest_tag=$(git tag --sort=-v:refname | grep '^v' | head -n1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0"
          fi
      
          number=$(echo "$latest_tag" | grep -oE '[0-9]+$')
          new_number=$((number + 1))
          new_version="v$new_number"
      
          echo "New version: $new_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT


     - name: Increment Version Number
       id: increment_version
       run: |
         latest_tag=${{ steps.latest_tag.outputs.latest_tag }}
         number=$(echo "$latest_tag" | grep -oE '[0-9]+$')
         if [ -z "$number" ]; then
          number=0
         fi
         new_number=$((number + 1))
         new_version="v$new_number"
         echo "New version: $new_version"
         echo "::set-output name=new_version::$new_version"


     - name: Create Logs Directory
       run: |
         mkdir -p logs/fgv-logger
         cd logs/fgv-logger
         touch access.log error.log
    
     - name: Build Docker Image
       run: docker build -t $DOCKER_USERNAME/$DOCKER_REPO:${{ steps.increment_version.outputs.new_version }} .


     - name: Push Docker Image
       run: docker push $DOCKER_USERNAME/$DOCKER_REPO:${{ steps.increment_version.outputs.new_version }}
